// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 搜索历史表
model SearchHistory {
  id          Int      @id @default(autoincrement())
  keyword     String
  searchTime  DateTime @default(now()) @map("search_time")
  articleCount Int?    @map("article_count")
  avgRead     Int?     @map("avg_read")
  avgLike     Int?     @map("avg_like")
  originalRate Float?  @map("original_rate")
  status      String   @default("completed") // 'completed', 'failed', 'processing'
  errorMessage String? @map("error_message")
  type        String   @default("wechat") // 'wechat', 'xiaohongshu'
  duration    Int?     @map("duration") // 分析耗时(秒)

  // 关联分析结果
  analysisResult AnalysisResult?

  @@map("search_history")
}

// 分析结果表
model AnalysisResult {
  id                     Int      @id @default(autoincrement())
  searchHistoryId        Int      @unique @map("search_history_id")
  insights               String   // JSON格式的洞察列表（原字段，保持兼容）
  wordCloud              String   @map("word_cloud") // JSON格式的词云数据
  topLikedArticles       String   @map("top_liked_articles") // JSON格式的TOP文章
  topInteractionArticles String   @map("top_interaction_articles") // JSON格式的TOP互动文章
  allArticles            String   @map("all_articles") // JSON格式的完整文章数据
  createdAt              DateTime @default(now()) @map("created_at")

  // 新增AI分析相关字段
  aiSummaries              String?  @map("ai_summaries")           // AI摘要JSON
  structuredInfo           String?  @map("structured_info")        // 结构化信息JSON
  aiInsights               String?  @map("ai_insights")            // AI洞察JSON
  structuredTopicInsights  String?  @map("structured_topic_insights") // 结构化选题洞察JSON

  // 洞察分类追踪
  ruleBasedInsights        String?  @map("rule_based_insights")    // 规则洞察JSON
  aiGeneratedInsights      String?  @map("ai_generated_insights")  // 纯AI洞察JSON

  // 元数据
  analysisVersion          String   @default("1.0")                // 分析版本
  aiModelUsed              String?  @map("ai_model_used")           // 使用的AI模型
  processingTime           Int?     @map("processing_time")        // 处理耗时(秒)
  aiAnalysisStatus         String?  @map("ai_analysis_status")     // AI分析状态

  // 关联搜索历史
  searchHistory SearchHistory @relation(fields: [searchHistoryId], references: [id], onDelete: Cascade)

  @@map("analysis_results")
}

// 文章表
model Article {
  id                   Int      @id @default(autoincrement())
  title                String
  content              String
  htmlContent          String?  @map("html_content")  // 带HTML格式的内容（包含图片）
  plainContent         String?  @map("plain_content")  // 纯文本内容（用于搜索）

  // 创作相关参数
  platform             String                    // 'wechat' | 'xiaohongshu'
  style                String                    // 'professional' | 'casual' | 'humorous'
  length               String                    // 'short' | 'medium' | 'long'
  targetPlatforms      String  @map("target_platforms") // JSON: ["wechat", "xiaohongshu"]
  customInstructions   String? @map("custom_instructions")

  // 洞察关联
  insightId            String? @map("insight_id")
  topicDirection       String? @map("topic_direction")

  // 配图相关
  hasImages            Boolean @default(false) @map("has_images")
  imageConfig          String?  @map("image_config")  // JSON: 配图配置

  // 状态和元数据
  status               String   @default("draft")  // 'draft' | 'pending' | 'published' | 'withdrawn'
  estimatedReadingTime Int?     @map("estimated_reading_time")
  sections             String?  // JSON: 文章章节

  // 时间戳
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // 关联发布记录
  publishRecords       PublishRecord[]

  @@map("articles")
}

// 发布记录表
model PublishRecord {
  id           Int      @id @default(autoincrement())
  articleId    Int      @map("article_id")
  platform     String   // 'wechat' | 'xiaohongshu'
  status       String   @default("pending") // 'pending' | 'published' | 'failed' | 'withdrawn'

  // 发布相关数据
  publishedUrl String?  @map("published_url")
  publishedAt  DateTime? @map("published_at")
  withdrawnAt  DateTime? @map("withdrawn_at")

  // 错误信息
  errorMessage String?  @map("error_message")
  retryCount   Int      @default(0) @map("retry_count")

  // 平台返回的数据
  platformData String?  @map("platform_data") // JSON: 平台返回的ID、统计数据等

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联文章
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@map("publish_records")
}
